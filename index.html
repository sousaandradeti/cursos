<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Confirma칞칚o de Curso</title>

<style>
  /* Estilos de Layout Base */
  body { font-family: Arial, sans-serif; background:#f7f7f7; padding:40px; }
 먝
  .box {
    background:white;
    max-width:400px;
    margin:auto;
    /* AUMENTO DO PREENCHIMENTO (PADDING) INTERNO */
    padding: 30px 40px; /* 30px superior/inferior, 40px lateral */
    border-radius:10px;
    box-shadow:0 0 15px #00000025;
    box-sizing: border-box; /* Garante que o padding n칚o estoure o max-width */
  }
 먝
  h2 {
    text-align:center;
    margin-bottom: 25px;
  }
 먝
  /* Estilo para campos de input e bot칚o */
  input[type="text"], input[type="email"], button {
    width: 100%;
    padding: 12px;
    margin-top: 0;
    margin-bottom: 15px;
    border-radius: 6px;
    font-size: 16px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
 먝
  button {
    background:#0176ff;
    color:white;
    cursor:pointer;
    border:none;
    padding: 14px;
    margin-top: 20px;
    font-weight: bold;
    transition: background-color 0.2s;
  }
 먝
  button:hover {
    background:#005ad1;
  }
 먝
  .hidden {
    display: none !important;
  }

  /* --- Estilos para o Seletor de Emojis (Rating) --- */
  .rating-box {
    display: flex;
    justify-content: space-between;
    direction: rtl;
    margin: 15px 0 25px 0;
  }

  .rating-box input[type="radio"] {
    display: none;
  }

  .rating-box label {
    font-size: 40px;
    color: #ccc;
    cursor: pointer;
    padding: 0 2px;
    transition: color 0.2s, transform 0.2s;
    position: relative;
    min-width: 45px;
    text-align: center;
  }

  /* Define os emojis para cada ponto */
  .rating-box label[for="star5"]::before { content: '游'; }
  .rating-box label[for="star4"]::before { content: '游뗵'; }
  .rating-box label[for="star3"]::before { content: '游땛'; }
  .rating-box label[for="star2"]::before { content: '游뗴'; }
  .rating-box label[for="star1"]::before { content: '游땨'; }

  /* Efeito de hover e sele칞칚o */
  .rating-box label:hover,
  .rating-box label:hover ~ label,
  .rating-box input[type="radio"]:checked ~ label {
    color: #ffc107;
    transform: scale(1.1);
  }

  .rating-box input[type="radio"]:checked + label {
    color: #ff9800;
  }

  /* Estilo para o check de sele칞칚o */
  .rating-box input[type="radio"]:checked + label::after {
    content: '\2713';
    position: absolute;
    bottom: -15px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745;
    color: white;
    font-size: 14px;
    line-height: 1;
    padding: 3px 6px;
    border-radius: 50%;
    z-index: 10;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
 먝
  /* --- Estilos para a Mensagem de Sucesso e irecionamento --- */
  .success-box {
    text-align: center;
    /* Padding ajustado para a tela de sucesso */
    padding: 50px 40px !important;
  }
  .success-box h2 {
    color: #28a745;
    margin-bottom: 10px;
  }
  .success-box p {
    margin-bottom: 25px;
    color: #555;
  }
  /* Novo estilo para a tela de irecionamento imediato */
  .redirect-box h2 {
    color: #0176ff;
  }

  .button-link {
    display: inline-block;
    width: 100%;
    padding: 14px; /* Usa o mesmo padding do bot칚o */
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    text-decoration: none;
    background:#0176ff;
    color:white;
    transition: background-color 0.2s;
  }
  .button-link:hover {
    background: #005ad1;
  }
</style>
</head>
<body>

<div class="box success-box hidden">
  <h2 id="final-message-title">游꿀 Avalia칞칚o Enviada!</h2>
  <p id="success-message">Obrigado! Sua avalia칞칚o foi registrada com sucesso.</p>
 먝
    <a href="https://sousaandrade.sharepoint.com/" target="_blank" class="button-link">Voltar para o In칤cio</a>
</div>

<div class="box main-box">
  <h2>Cursos Sousa Andrade Academy</h2>

  <form id="submissionForm">
        <input type="hidden" id="scriptUrl" value="https://script.google.com/macros/s/AKfycbw2VStVhvm7RgR6GchtLXpV2XE8hkX95GweWGLWkVIupz7gW0UH9DwUwLxmPrbbVLQ/exec">
   먝
    <input type="text" name="nome" placeholder="Seu nome" required>
    <input type="email" name="email" placeholder="Seu email" required>
    <input type="hidden" name="curso" id="curso">
   먝
        <div id="rating-section">
      <label id="course-label" style="margin-top: 0; margin-bottom: 10px; display: block;">Sua Avalia칞칚o do Curso:</label>
      <div class="rating-box">
        <input type="radio" id="star5" name="nota" value="5" required />
        <label for="star5" title="Excelente (5)"></label>

        <input type="radio" id="star4" name="nota" value="4" />
        <label for="star4" title="Bom (4)"></label>

        <input type="radio" id="star3" name="nota" value="3" />
        <label for="star3" title="Razo치vel (3)"></label>

        <input type="radio" id="star2" name="nota" value="2" />
        <label for="star2" title="Ruim (2)"></label>

        <input type="radio" id="star1" name="nota" value="1" />
        <label for="star1" title="Muito Ruim (1)"></label>
      </div>
    </div>

    <input type="hidden" name="status" id="status">
   먝
    <button type="submit" id="submitButton">Concluir</button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const p = new URLSearchParams(window.location.search);
   먝
    // Elementos do DOM
    const form = document.getElementById("submissionForm");
    const courseLabel = document.getElementById("course-label");
    const ratingSection = document.getElementById("rating-section");
    const notaInputs = document.querySelectorAll('input[name="nota"]');
    const mainBox = document.querySelector(".main-box");
    const successBox = document.querySelector(".success-box");
    const finalMessageTitle = document.getElementById("final-message-title");
    const successMessage = document.getElementById("success-message");
    const redirectLink = document.querySelector(".button-link");
    const submitButton = document.getElementById("submitButton"); // Pego o bot칚o por ID

    // URL do App Script (AGORA ATUALIZADA)
    const SCRIPT_URL = document.getElementById("scriptUrl").value;
    // O REDIRECT_YOUTUBE foi removido e ser치 buscado dinamicamente

    // --- Fun칞칚o Simples de Capitaliza칞칚o ---
    function capitalizeFirstLetter(string) {
      if (!string) return '';
      string = string.toLowerCase();
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
   먝
    // --- 1. L칩gica para o Curso ---
    let cursoValue = p.get("curso");
   먝
    if (cursoValue) {
      let displayName = cursoValue.replace(/_/g, ' ');
      displayName = displayName.split(' ').map((word, index) => {
        return (index === 0) ? capitalizeFirstLetter(word) : word;
      }).join(' ');
     먝
      document.getElementById("curso").value = cursoValue;
      courseLabel.textContent = `Sua Avalia칞칚o do Curso: ${displayName}`;
    } else {
      courseLabel.textContent = "Sua Avalia칞칚o do Curso:";
      console.warn("Par칙metro 'curso' ausente na URL.");
    }

    // --- 2. L칩gica para o Status (Iniciado vs. Conclu칤do) ---
    const statusValue = p.get("status");
    document.getElementById("status").value = statusValue || "";
   먝
    // Verifica se o status 칠 "iniciado" (caso 1)
    if (statusValue && statusValue.toLowerCase() === "iniciado") {
     먝
      // 1. Oculta a avalia칞칚o
      ratingSection.style.display = 'none';

      // 2. Remove o 'required' da nota
      notaInputs.forEach(input => {
        input.removeAttribute('required');
      });

      // 3. Altera o texto do bot칚o para "Iniciar Curso"
      submitButton.textContent = 'Iniciar Curso';
     먝
    } else {
      // Para status vazio ou qualquer outro valor (caso 2 - Conclus칚o), a avalia칞칚o 칠 vis칤vel
      ratingSection.style.display = 'block';
      notaInputs.forEach(input => {
        input.setAttribute('required', 'required');
      });
      submitButton.textContent = 'Concluir';
    }

    // --- Fun칞칚o para buscar a URL do curso (Requer o doGet no App Script) ---
    async function fetchCourseUrl(courseCode) {
      // Envia o c칩digo do curso como par칙metro GET para o App Script
      const fetchUrl = `${SCRIPT_URL}?action=geturl&curso=${courseCode}`;

      try {
        const response = await fetch(fetchUrl);
        if (!response.ok) throw new Error('Falha ao buscar URL.');
       먝
        // O App Script deve retornar a URL como texto puro
        const urlData = await response.text();
        return urlData.trim();
      } catch (error) {
        console.error("Erro ao buscar URL do curso:", error);
        // URL Fallback
        return "https://sousaandrade.sharepoint.com/"; 
      }
    }
   먝
    // --- 3. L칍GICA DE SUBMISS츾O COM FETCH ---
    form.addEventListener('submit', async function(e) { 
      e.preventDefault();
     먝
      // Exibe feedback visual de envio
      submitButton.textContent = 'Aguarde...';
      submitButton.disabled = true;

      const formData = new FormData(form);

      try {
        // 1. Envia os dados do formul치rio (POST)
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        const data = await response.text();
       먝
        // SE O REGISTRO DO FORMUL츼RIO FOI BEM-SUCEDIDO:
        if (data.trim() === 'REGISTRO_OK') {
          
          // 2. Busca a URL Din칙mica
          const finalRedirectUrl = await fetchCourseUrl(cursoValue);

          // Se o status for "iniciado" (Caso 1 - Redirecionamento Imediato)
          if (statusValue && statusValue.toLowerCase() === "iniciado") {
           먝
            // 3. Configura tela de espera e inicia contagem
            mainBox.classList.add('hidden');
            successBox.classList.remove('hidden');
            successBox.classList.add('redirect-box');
            finalMessageTitle.textContent = 'Iniciando o Curso...';
            redirectLink.classList.add('hidden');
           먝
            let countdown = 5;
            successMessage.innerHTML = `Aguarde, seu curso come칞ar치 em alguns instantes. Redirecionando em <span id="countdown">${countdown}</span> segundos.`;

            const countdownElement = document.getElementById("countdown");

            const interval = setInterval(() => {
              countdown--;
              if (countdownElement) countdownElement.textContent = countdown;
             먝
              if (countdown <= 0) {
                clearInterval(interval);
                window.top.location.href = finalRedirectUrl; // Redireciona para a URL buscada
              }
            }, 1000);

          } else {
            // Se o status n칚o for "iniciado" (Caso 2 - Conclus칚o/Avalia칞칚o)
            
            // Configura o bot칚o "Voltar para o In칤cio" com a URL din칙mica
            redirectLink.href = finalRedirectUrl;

            // Mostra a tela de sucesso padr칚o
            mainBox.classList.add('hidden');
            successBox.classList.remove('hidden');
            successBox.classList.remove('redirect-box');
            finalMessageTitle.textContent = '游꿀 Curso Conlu칤do!!!';
            successMessage.textContent = 'Obrigado! Sua avalia칞칚o foi registrada com sucesso.';
            redirectLink.classList.remove('hidden');

          }
        } else {
          // Trata erros de registro (resposta App Script n칚o foi 'REGISTRO_OK')
          console.error('Houve um erro no registro ou resposta inesperada:', data.trim());
          const btnText = (statusValue && statusValue.toLowerCase() === "iniciado") ? 'Iniciar Curso' : 'Concluir';
          submitButton.textContent = btnText;
          submitButton.disabled = false;
        }
      } catch(error) {
        console.error('Erro na submiss칚o ou busca da URL:', error);
        const btnText = (statusValue && statusValue.toLowerCase() === "iniciado") ? 'Iniciar Curso' : 'Concluir';
        submitButton.textContent = btnText;
        submitButton.disabled = false;
      }
    });

  });
</script>

</body>
</html>
